services:
  db:
    image: mia83/mariadb:11.1.2
    restart: always
    env_file:
      - ./db/mariadb.env
    volumes:
      - type: bind
        source: ./db/docker-entrypoint-initdb.d
        target: /docker-entrypoint-initdb.d
      - type: bind
        source: ./db/conf.d
        target: /etc/mysql/conf.d
        read_only: true
      - mariadb-data-dir:/var/lib/mysql
      - mariadb-socket:/var/run/mysqld
      - mariadb-dump:/dump
    networks:
      - library_net
    ports:
      - 3307:4808
    secrets:
      - server.key
      - CA.pem
      - server.pem
      - MARIADB_USER.pwd
      - MARIADB_ROOT.pwd


  db-backup:
    image: mariadb:11.1.2
    env_file:
      - /db/mariadb.env
    volumes:
      - mariadb-data-dir:/var/lib/mysql
      - mariadb-socket:/var/run/mysqld
      - mariadb-backup:/backup
      - mariadb-dump:/dump
      - type: bind
        source: ./db/custom_scripts
        target: /custom_scripts
    secrets:
      - MARIADB_ROOT.pwd    

  web:
    image: mia83/library-web:latest
    build:
      context: .
      dockerfile: WebDockerFile
    restart: always
    ports:
      - 9080:80
    networks:
      - library_net
    secrets:
      - CA.pem
      - client.pem
      - client.key

  

networks:
  library_net:
    external: true

volumes:
  mariadb-data-dir:
  mariadb-socket:
  mariadb-backup:
  mariadb-dump:

secrets:
  server.key:
    file: C:\Docker\git_projects\secrets\Library\MIAHomeLabMARIA_DB.key
  CA.pem:
    file: C:\Docker\git_projects\secrets\Library\MIAHomeLabCA.crt
  server.pem:
    file: C:\Docker\git_projects\secrets\Library\MIAHomeLabMARIA_DB.crt
  MARIADB_USER.pwd:
    file: C:\Docker\git_projects\secrets\Library\MARIADB_USER.pwd
  MARIADB_ROOT.pwd:
    file: C:\Docker\git_projects\secrets\Library\MARIADB_ROOT.pwd
  client.key:
    file: C:\Docker\git_projects\secrets\Library\MIAHomeLabDBClient.key
  client.pem:
    file: C:\Docker\git_projects\secrets\Library\MIAHomeLabDBClient.crt
